import React, { useState, useRef, useEffect } from 'react';
import { Download, X } from 'lucide-react';

const CharacterCreator = () => {
  const [selectedComponents, setSelectedComponents] = useState({
    body: null,
    mouth: null,
    eyes: null,
    head: null,
    accessory: null
  });
  
  const [componentPositions, setComponentPositions] = useState({
    body: { x: 0, y: 0 },
    mouth: { x: 0, y: 0 },
    eyes: { x: 0, y: 0 },
    head: { x: 0, y: 0 },
    accessory: { x: 0, y: 0 }
  });
  
  const [selectedForMoving, setSelectedForMoving] = useState(null);
  const [showBodySelector, setShowBodySelector] = useState(false);
  
  const previewRef = useRef(null);
  
  // Component counts - adjust these based on your actual assets
  const componentCounts = {
    body: 5,
    mouth: 5, 
    eyes: 5,
    head: 5,
    accessory: 5
  };
  
  // Generate component lists based on counts
  const generateComponents = (category, count) => {
    const components = [{ id: 0, name: 'none', path: null }];
    for (let i = 1; i <= count; i++) {
      components.push({
        id: i,
        name: `${category}-${i}.png`,
        path: `./assets/${category}/${category}-${i}.png`
      });
    }
    return components;
  };
  
  const mockComponents = {
    body: generateComponents('body', componentCounts.body),
    mouth: generateComponents('mouth', componentCounts.mouth),
    eyes: generateComponents('eyes', componentCounts.eyes),
    head: generateComponents('head', componentCounts.head),
    accessory: generateComponents('accessory', componentCounts.accessory)
  };

  const selectComponent = (category, component) => {
    setSelectedComponents(prev => ({
      ...prev,
      [category]: component
    }));
    
    // Hide movement overlay when selecting a new component in same category
    if (selectedForMoving === category) {
      setSelectedForMoving(null);
    }
    
    // Hide body selector when body is chosen
    if (category === 'body') {
      setShowBodySelector(false);
    }
  };

  const removeComponent = (category) => {
    if (category === 'body') return; // Can't remove body
    setSelectedComponents(prev => ({
      ...prev,
      [category]: null
    }));
    setSelectedForMoving(null);
  };

  const moveComponent = (category, direction) => {
    const moveDistance = 5;
    setComponentPositions(prev => {
      const current = prev[category];
      let newX = current.x;
      let newY = current.y;
      
      // Calculate bounds based on 272x406 character area + padding
      const maxX = 100;
      const maxY = 150;
      
      switch(direction) {
        case 'up': newY = Math.max(current.y - moveDistance, -maxY); break;
        case 'down': newY = Math.min(current.y + moveDistance, maxY); break;
        case 'left': newX = Math.max(current.x - moveDistance, -maxX); break;
        case 'right': newX = Math.min(current.x + moveDistance, maxX); break;
        default: break;
      }
      
      return {
        ...prev,
        [category]: { x: newX, y: newY }
      };
    });
  };

  const exportToPDF = () => {
    if (!selectedComponents.body) {
      alert('Please select a body component before exporting');
      return;
    }
    
    // Create a canvas for 8.5x11" with margins
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const dpi = 300;
    const pageWidth = 8.5 * dpi;
    const pageHeight = 11 * dpi;
    const margin = 0.75 * dpi; // 0.75" margins
    
    canvas.width = pageWidth;
    canvas.height = pageHeight;
    
    // White background
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, pageWidth, pageHeight);
    
    // Character area centered on page
    const centerX = pageWidth / 2;
    const centerY = pageHeight / 2;
    
    // Placeholder for actual PNG rendering
    ctx.fillStyle = '#333';
    ctx.font = '24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Character Export', centerX, centerY - 50);
    ctx.fillText('(PNG stack rendering would go here)', centerX, centerY);
    
    // Convert to blob and download
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'character.pdf';
      a.click();
      URL.revokeObjectURL(url);
    });
  };

  const ComponentThumbnail = ({ component, isSelected, onClick }) => {
    if (component.id === 0) {
      // None option
      return (
        <button
          onClick={onClick}
          className={`flex-shrink-0 w-16 h-16 border-2 rounded-lg flex items-center justify-center transition-all ${
            isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white hover:border-gray-400'
          }`}
        >
          <span className="text-gray-400 text-lg">âˆ…</span>
        </button>
      );
    }
    
    return (
      <button
        onClick={onClick}
        className={`flex-shrink-0 w-16 h-16 border-2 rounded-lg overflow-hidden transition-all ${
          isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white hover:border-gray-400'
        }`}
      >
        <img
          src={component.path}
          alt={component.name}
          className="w-full h-full object-contain"
          onError={(e) => {
            // Fallback display for missing images
            e.target.style.display = 'none';
            e.target.nextSibling.style.display = 'flex';
          }}
        />
        <div className="w-full h-full flex items-center justify-center text-xs text-gray-400" style={{display: 'none'}}>
          {component.name}
        </div>
      </button>
    );
  };

  const ComponentSelector = ({ category, title }) => {
    const components = mockComponents[category];
    
    return (
      <div className="mb-4">
        <h3 className="font-medium text-gray-700 mb-2">{title}</h3>
        <div className="flex gap-2 overflow-x-auto pb-2">
          {components.map(component => (
            <ComponentThumbnail
              key={component.id}
              component={component}
              isSelected={selectedComponents[category]?.id === component.id}
              onClick={() => selectComponent(category, component)}
            />
          ))}
        </div>
      </div>
    );
  };

  const MovementOverlay = ({ category }) => {
    if (selectedForMoving !== category) return null;
    
    return (
      <div className="absolute -bottom-20 left-1/2 transform -translate-x-1/2 bg-yellow-100 border-2 border-yellow-400 rounded-lg p-3 shadow-lg z-50">
        <div className="flex items-center justify-between mb-2">
          <span className="text-xs font-medium text-yellow-800 capitalize">{category}</span>
          <button
            onClick={() => removeComponent(category)}
            className="p-1 text-red-500 hover:text-red-700"
          >
            <X size={12} />
          </button>
        </div>
        <div className="grid grid-cols-3 gap-1">
          <div></div>
          <button
            onClick={() => moveComponent(category, 'up')}
            className="p-2 bg-white hover:bg-gray-100 rounded text-xs border"
          >
            â–²
          </button>
          <div></div>
          <button
            onClick={() => moveComponent(category, 'left')}
            className="p-2 bg-white hover:bg-gray-100 rounded text-xs border"
          >
            â—€
          </button>
          <button
            onClick={() => setSelectedForMoving(null)}
            className="p-2 bg-white hover:bg-gray-100 rounded text-xs border font-medium"
          >
            âœ“
          </button>
          <button
            onClick={() => moveComponent(category, 'right')}
            className="p-2 bg-white hover:bg-gray-100 rounded text-xs border"
          >
            â–¶
          </button>
          <div></div>
          <button
            onClick={() => moveComponent(category, 'down')}
            className="p-2 bg-white hover:bg-gray-100 rounded text-xs border"
          >
            â–¼
          </button>
          <div></div>
        </div>
      </div>
    );
  };

  const BodySelector = () => {
    if (!showBodySelector) return null;
    
    return (
      <div className="absolute top-12 left-0 bg-yellow-100 border-2 border-yellow-400 rounded-lg p-4 shadow-lg z-50 max-w-md">
        <div className="flex items-center justify-between mb-3">
          <span className="font-medium text-yellow-800">Select Body</span>
          <button
            onClick={() => setShowBodySelector(false)}
            className="p-1 text-gray-500 hover:text-gray-700"
          >
            <X size={16} />
          </button>
        </div>
        <div className="grid grid-cols-4 gap-2 max-h-64 overflow-y-auto">
          {mockComponents.body.slice(1).map(body => (
            <ComponentThumbnail
              key={body.id}
              component={body}
              isSelected={selectedComponents.body?.id === body.id}
              onClick={() => selectComponent('body', body)}
            />
          ))}
        </div>
      </div>
    );
  };

  const CharacterLayer = ({ category, zIndex }) => {
    const component = selectedComponents[category];
    if (!component || component.id === 0) return null;
    
    const position = componentPositions[category];
    
    return (
      <div
        className="absolute cursor-pointer"
        style={{
          transform: `translate(${position.x}px, ${position.y}px)`,
          zIndex: zIndex
        }}
        onClick={() => setSelectedForMoving(selectedForMoving === category ? null : category)}
      >
        <div className="relative">
          <img
            src={component.path}
            alt={component.name}
            className={`max-w-none transition-all ${
              selectedForMoving === category ? 'ring-2 ring-yellow-400' : ''
            }`}
            style={{ width: '272px', height: '406px' }}
            onError={(e) => {
              // Fallback for missing images
              e.target.style.display = 'none';
              e.target.nextSibling.style.display = 'flex';
            }}
          />
          <div 
            className="flex items-center justify-center bg-gray-200 border-2 border-dashed border-gray-400 text-gray-500 text-sm"
            style={{ width: '272px', height: '406px', display: 'none' }}
          >
            {component.name}
          </div>
          <MovementOverlay category={category} />
        </div>
      </div>
    );
  };

  const CharacterPreview = () => {
    return (
      <div className="relative w-full h-full flex items-center justify-center overflow-hidden">
        {/* Character layers in z-index order */}
        <CharacterLayer category="body" zIndex={0} />
        <CharacterLayer category="mouth" zIndex={1} />
        <CharacterLayer category="eyes" zIndex={2} />
        <CharacterLayer category="head" zIndex={3} />
        <CharacterLayer category="accessory" zIndex={4} />
        
        {!selectedComponents.body && (
          <div className="text-gray-400 text-center">
            <div className="w-64 h-96 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center">
              <div className="text-6xl mb-4">ðŸ‘¤</div>
              <div className="text-lg font-medium mb-2">Blank Slate</div>
              <div className="text-sm">Click "Body" to start building</div>
            </div>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="flex h-screen bg-gray-100 p-4">
      {/* Left Panel - Preview */}
      <div className="flex-1 mr-4">
        <div className="bg-white rounded-lg border-2 border-gray-300 h-full p-4 flex flex-col">
          <div className="flex items-center justify-between mb-4 relative">
            <button
              onClick={() => setShowBodySelector(!showBodySelector)}
              className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium flex items-center gap-2"
            >
              <span className="text-gray-400">ðŸŽ¨</span>
              Body
            </button>
            <BodySelector />
          </div>
          
          <div 
            ref={previewRef}
            className="flex-1 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 relative overflow-hidden"
          >
            <CharacterPreview />
          </div>
        </div>
      </div>
      
      {/* Right Panel - Components */}
      <div className="w-80 bg-white rounded-lg border-2 border-gray-300 p-4 flex flex-col">
        <div className="flex-1 overflow-y-auto">
          <ComponentSelector category="head" title="Head" />
          <ComponentSelector category="eyes" title="Eyes" />
          <ComponentSelector category="mouth" title="Mouth" />
          <ComponentSelector category="accessory" title="Accessory" />
        </div>
        
        <button
          onClick={exportToPDF}
          disabled={!selectedComponents.body}
          className={`w-full mt-4 py-3 px-4 rounded-lg font-medium flex items-center justify-center gap-2 ${
            selectedComponents.body
              ? 'bg-blue-600 hover:bg-blue-700 text-white'
              : 'bg-gray-200 text-gray-400 cursor-not-allowed'
          }`}
        >
          <Download size={18} />
          Export
        </button>
      </div>
    </div>
  );
};

export default CharacterCreator;
